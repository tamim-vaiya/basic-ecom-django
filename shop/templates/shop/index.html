<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecom Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">

    {% comment %} NavBar {% endcomment %}
    <nav class="bg-white shadow p-4 flex justify-between items-center">
        <div class="text-xl font-bold">The Goods Co.</div>

        <div class="flex items-center space-x-6">
            <a href="#" class="text-gray-700 hover:text-blue-600">Link1</a>
            <a href="#" class="text-gray-700 hover:text-blue-600">Link2</a>
            <!-- Cart with Popover -->
            <div x-data="{ open: false }" class="relative">
                <button @click="open = !open" class="text-gray-700 hover:text-blue-600 focus:outline-none" id="nav-cart">
                    Cart(0)
                </button>

                <!-- Popover -->
                <div
                    x-show="open"
                    @click.outside="open = false"
                    x-transition
                    class="absolute right-0 mt-2 w-80 bg-white shadow-md border rounded p-4 text-sm z-50"
                >
                    <h1 class="font-bold text-xl mb-3">Your Cart</h1>
                    <div id="cart-popover-content" class="space-y-2 text-sm">
                        <p class="text-gray-500">Your cart is empty.</p>
                    </div>
                </div>
            </div>
        </div>
    </nav>


    {% comment %} Search Bar {% endcomment %}
    <div class="container mx-auto px-4 py-8">
        <form method="GET" action="" class="max-w-md mx-auto">
            <div class="flex items-center bg-white border border-gray-300 rounded-full shadow-sm focus-within:ring-2 focus-within:ring-blue-400 overflow-hidden">
                <input
                    type="search"
                    name="item_name"
                    placeholder="Search products..."
                    class="flex-grow px-4 py-2 text-sm outline-none"
                    value="{{ request.GET.item_name|default:'' }}"
                >
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 text-sm font-medium hover:bg-blue-600 transition">
                    Search
                </button>
            </div>
        </form>
    </div>

    {% comment %} Products Grid {% endcomment %}
    <div class="container mx-auto p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for product in product_objects %}
            <div class="bg-white rounded-2xl shadow-md overflow-hidden hover:shadow-lg transition">
                <img src="{{ product.image }}" alt="{{ product.title }}" class="w-full aspect-square object-cover">
                <div class="p-4">
                    <h2 class="text-lg font-semibold mb-1">{{ product.title }}</h2>
                    <p class="text-green-600 font-bold text-md">$ {{ product.discount_price }}</p>
                    <p class="line-through text-gray-500 text-sm mb-3">$ {{ product.price }}</p>
                    <div class="flex justify-between">
                        <button 
                            id="{{product.id}}" 
                            class="atc bg-blue-500 text-white text-sm px-3 py-1 rounded hover:bg-blue-600" 
                            data-name="{{ product.title }}" 
                            data-price="{{ product.discount_price }}">
                            Add to Cart
                        </button>
                        <a href="{% url 'detail' product.id %}" class="bg-gray-200 text-sm px-3 py-1 rounded hover:bg-gray-300"> View Details </a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    {% comment %} Pagination {% endcomment %}
    <div class="container mx-auto px-4 py-6 flex justify-center">
        <nav class="inline-flex items-center space-x-1 text-sm">
            {% if product_objects.has_previous %}
                <a href="?{% if request.GET.item_name %}item_name={{ request.GET.item_name }}&{% endif %}page=1" class="px-3 py-2 rounded-l bg-white border border-gray-300 hover:bg-gray-100">&laquo; First</a>
                <a href="?{% if request.GET.item_name %}item_name={{ request.GET.item_name }}&{% endif %}page={{ product_objects.previous_page_number }}" class="px-3 py-2 bg-white border border-gray-300 hover:bg-gray-100">Prev</a>
            {% endif %}

            <span class="px-4 py-2 bg-blue-500 text-white border border-blue-500 rounded">{{ product_objects.number }}</span>

            {% if product_objects.has_next %}
                <a href="?{% if request.GET.item_name %}item_name={{ request.GET.item_name }}&{% endif %}page={{ product_objects.next_page_number }}" class="px-3 py-2 bg-white border border-gray-300 hover:bg-gray-100">Next</a>
                <a href="?{% if request.GET.item_name %}item_name={{ request.GET.item_name }}&{% endif %}page={{ product_objects.paginator.num_pages }}" class="px-3 py-2 rounded-r bg-white border border-gray-300 hover:bg-gray-100">Last &raquo;</a>
            {% endif %}
        </nav>
    </div>


</body>
<script type="text/javascript">

    if(localStorage.getItem('cart') == null){
        var cart = {};
    } else {
        cart = JSON.parse(localStorage.getItem('cart'));
    }

    // Map to store product info locally
    let productInfo = {};

    $(document).on('click', '.atc', function(){
        const item_id = this.id.toString();
        const item_name = $(this).data('name');
        const item_price = $(this).data('price');

        // Save product info if not already saved
        if (!productInfo[item_id]) {
            productInfo[item_id] = {
                name: item_name,
                price: item_price
            };
        }

        if(cart[item_id] != undefined){
            cart[item_id] += 1;
        } else {
            cart[item_id] = 1;
        }

        localStorage.setItem('cart', JSON.stringify(cart));
        localStorage.setItem('productInfo', JSON.stringify(productInfo));

        updateCartDisplay();
    });

    // Update cart count on nav
    function updateCartDisplay() {
        document.getElementById("nav-cart").innerHTML = "Cart(" + Object.keys(cart).length + ")";
    }

    // Update cart popover content
    function updateCartPopover() {
        const popover = document.getElementById('cart-popover-content');
        const cart = JSON.parse(localStorage.getItem('cart') || '{}');
        const productInfo = JSON.parse(localStorage.getItem('productInfo') || '{}');

        if (Object.keys(cart).length === 0) {
            popover.innerHTML = `<p class="text-gray-500">Your cart is empty.</p>`;
            return;
        }

        let content = '';
        for (let id in cart) {
            const quantity = cart[id];
            const info = productInfo[id];

            if (info) {
                content += `<div class="flex justify-between">
                    <span>${quantity}x ${info.name}</span>
                    <span>$${(quantity * info.price).toFixed(2)}</span>
                </div>`;
            }
        }

        popover.innerHTML = content;
    }

    // Initial page load
    document.addEventListener("DOMContentLoaded", function () {
        if (localStorage.getItem('cart')) {
            cart = JSON.parse(localStorage.getItem('cart'));
            updateCartDisplay();
        }

        if (localStorage.getItem('productInfo')) {
            productInfo = JSON.parse(localStorage.getItem('productInfo'));
        }

        // Listen to Alpine.js popover toggle
        document.querySelector('#nav-cart').addEventListener('click', () => {
            setTimeout(updateCartPopover, 50); // delay to wait for popover render
        });
    });

</script>

</html>